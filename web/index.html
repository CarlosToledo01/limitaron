<!doctype html>
<html lang="es">
<head>

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-KG3ZYVW8DT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-KG3ZYVW8DT');
  </script>

  <meta charset="utf-8" />
  <title>LIMATRON üçã</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Tipograf√≠a universitaria -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Graduate&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #e5d3a0;       /* fondo dorado m√°s saturado/oscuro */
      --card: #0f1a45;     /* tarjetas azules */
      --muted: #9fb3d3;    /* textos secundarios */
      --fg: #f4f6fb;       /* texto principal en tarjetas */
      --acc: #c7aa52;      /* dorado menos amarillento */
      --border: #1c2a5c;   /* bordes base */
      --pill: #13214a;     /* pills y tabs */
      --danger: #dc2626;
      --warn: #f59e0b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: #0e162f;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap { max-width: 1280px; margin: 2rem auto; padding: 0 1.25rem; }
    h1 {
      margin: 0 0 1.6rem;
      font-weight: 800;
      font-size: clamp(2.2rem, 5vw, 3.2rem);
      letter-spacing: .5px;
      display: flex;
      align-items: center;
      gap: .6rem;
      font-family: 'Graduate', system-ui, sans-serif;
      color: #0f1a45;
      -webkit-text-stroke: 1.5px #000;
      text-shadow: 0 2px 4px rgba(0,0,0,0.25);
    }
    h1 .emoji { font-size: clamp(2rem, 5vw, 3rem); line-height: 1; }

    .grid-main { display: grid; grid-template-columns: 470px 1fr; gap: 1.5rem; }
    @media (max-width:980px){ .grid-main{ grid-template-columns: 1fr; } }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 1.25rem 1.25rem 1.4rem;
      border-radius: 1.1rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.25);
      color: var(--fg);
    }

    form#calcForm { display: flex; flex-direction: column; gap: 1.25rem; }
    .section { display: flex; flex-direction: column; gap: .9rem; }
    .section h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 800;
      color: #d5def0;
      letter-spacing: .5px;
    }
    .field-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
      gap: .75rem;
      width: 100%;
    }
    .field { display: flex; flex-direction: column; gap: .4rem; width: 100%; }
    label {
      font-size: .68rem;
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      color: #c2cde5;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0;
    }

    /* Inputs y selects con contorno dorado difuminado en hover/focus */
    input, select {
      width: 100%;
      padding: .85rem .95rem;
      border-radius: .8rem;
      border: 1px solid #1d2d60;
      background: #0b1538;
      color: var(--fg);
      font-size: .9rem;
      font-weight: 500;
      outline: none;
      transition: border-color .18s ease, background .18s ease, box-shadow .18s ease;
      min-height: 44px;
      box-shadow:
        inset 0 0 0 1px #c7aa5233,
        0 0 0 0 rgba(199,170,82,0);
    }
    input::placeholder { color: #b6c3df; opacity: 0.9; }
    input:hover, select:hover,
    input:focus, select:focus {
      border-color: #c7aa5280;
      background: #101c46;
      box-shadow:
        inset 0 0 0 1px #c7aa52b3,
        0 0 0 2px #c7aa5233,
        0 0 14px 3px #c7aa5233;
    }

    .actions { display: flex; flex-direction: column; gap: .75rem; margin-top: .25rem; }
    .actions .row { display: flex; gap: .65rem; flex-wrap: wrap; }
    button {
      background: var(--acc);
      border: none;
      color: #0b1230;
      font-weight: 800;
      padding: .75rem 1.1rem;
      border-radius: .75rem;
      cursor: pointer;
      font-size: .95rem;
      letter-spacing: .5px;
      min-height: 44px;
      transition: transform .1s ease, box-shadow .18s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,0.28); }
    button:active { transform: translateY(0); box-shadow: 0 3px 10px rgba(0,0,0,0.22); }
    button.secondary { background: #13214a; color: var(--fg); }
    button.small { padding: .5rem .8rem; font-size: .78rem; }
    button:disabled { opacity: .55; cursor: not-allowed; }

    /* Bot√≥n recalcular en dorado */
    #btnRecalc { background: var(--acc); color: #0b1230; }

    .tabs { display: flex; gap: .4rem; border-bottom: 1px solid var(--border); margin-bottom: .95rem; flex-wrap: wrap; }
    .tab {
      background: #0b1538;
      border: 1px solid var(--border);
      border-bottom: none;
      color: #cbd8f0;
      padding: .6rem .9rem;
      border-top-left-radius: .8rem;
      border-top-right-radius: .8rem;
      cursor: pointer;
      font-weight: 600;
      font-size: .78rem;
      letter-spacing: .05em;
      opacity: .9;
      transition: background .15s, border-color .15s;
    }
    .tab.active { background: var(--card); color: #fff; opacity: 1; border-color: #c7aa524d; }
    .tab-panel { display: none; animation: fade .18s ease-in; }
    .tab-panel.active { display: block; }
    @keyframes fade { from{opacity:0; transform:translateY(4px);} to{opacity:1; transform:translateY(0);} }

    table { width: 100%; border-collapse: collapse; font-size: .78rem; color: var(--fg); }
    th, td { padding: .5rem .55rem; border-bottom: 1px solid var(--border); text-align: left; vertical-align: middle; }
    th { color: #c2cde5; font-weight: 600; letter-spacing: .05em; }

    pre {
      background: #0b122f;
      padding: 1rem 1.1rem;
      border-radius: .75rem;
      font-size: .78rem;
      line-height: 1.15rem;
      overflow: auto;
      white-space: pre-wrap;
      color: var(--fg);
    }

    .panel-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: .6rem; color: var(--fg); }
    .pill { background: var(--pill); padding: .35rem .75rem; border-radius: 1.2rem; font-size: .6rem; font-weight: 700; letter-spacing: .05em; }
    .ok { color: #22c55e; } .error { color: #dc2626; } .warn { color: #f59e0b; }
    .muted { color: var(--muted); font-size: .8rem; }

    .sld-wrap {
      background: #ffffff;
      border: 1px solid #d1d5db;
      padding: .9rem;
      border-radius: .8rem;
      overflow: auto;
      color: #0e162f;
    }
    .sld-wrap svg { width: 100%; height: auto; display: block; }

    .toolbar { display: flex; gap: .6rem; flex-wrap: wrap; margin: .6rem 0 .85rem; }
    .toolbar button { background: #13214a; color: var(--fg); }

    @media (max-width:640px) {
      .wrap { padding: 0 .8rem; }
      h1 { font-size: clamp(1.6rem, 7vw, 2.2rem); }
      .actions .row { flex-direction: column; }
      .actions .row > * { width: 100%; }
      .tabs { position: sticky; top: 0; z-index: 10; background: var(--card); padding-top: .3rem; }
      .toolbar { position: sticky; top: 46px; z-index: 9; background: var(--card); padding: .4rem 0; }
      table { font-size: .76rem; }
    }

    .repeat-list { display: flex; flex-direction: column; gap: .5rem; }
    .repeat-item { display: grid; grid-template-columns: 1fr 1fr; gap: .6rem; align-items: center; color: var(--fg); }
    .repeat-item label { font-size: .75rem; text-transform: none; letter-spacing: .02em; color: #cbd8f0; }

    .error-box {
      display: none;
      background: #2a1010;
      color: #fecaca;
      border: 1px solid #7f1d1d;
      border-radius: .75rem;
      padding: .75rem 1rem;
      font-size: .85rem;
      line-height: 1.2rem;
    }
    .error-box.show { display: block; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span>LIMATRON</span><span class="emoji">üçã</span></h1>

    <div class="grid-main">
      <!-- ENTRADA -->
      <div class="card">
        <form id="calcForm" onsubmit="return false;">
          <div class="section">
            <h3>Cargas generales</h3>
            <div class="field-row">
              <div class="field">
                <label>Focos</label>
                <input name="Focos" type="number" value="12" min="0" inputmode="numeric" />
              </div>
              <div class="field">
                <label>Potencia foco (W)</label>
                <input name="PotFoco_W" type="number" value="9" min="1" inputmode="numeric" />
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label>Contactos</label>
                <input name="Contactos" type="number" value="6" min="0" inputmode="numeric" />
              </div>
              <div class="field">
                <label>Contactos especiales</label>
                <input name="ContactosEspeciales" type="number" value="0" min="0" inputmode="numeric" />
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Bombas</h3>
            <div class="field-row">
              <div class="field">
                <label>Bombas (unidades)</label>
                <input name="Bombas" type="number" value="0" min="0" inputmode="numeric" id="inpBombas" />
              </div>
              <div class="field">
                <label>HP Bombas (lista)</label>
                <input name="Bombas_HP_List" type="text" placeholder="1, 0.5" id="inpBombasHP" />
              </div>
            </div>
            <div class="field">
              <label>Tipos de conexi√≥n por bomba</label>
              <div id="bombasRepeater" class="repeat-list"></div>
            </div>
          </div>

          <div class="section">
            <h3>Contactos espec√≠ficos</h3>
            <div class="field-row">
              <div class="field">
                <label>Cantidad</label>
                <input name="ContactosEspecificos_Cant" type="number" value="0" min="0" inputmode="numeric" id="inpCspCant" />
              </div>
              <div class="field">
                <label>Potencias (W) lista</label>
                <input name="ContactosEspecificos_W_List" type="text" placeholder="800, 1200, 600" id="inpCspW" />
              </div>
            </div>
            <div class="field">
              <label>Tipos de conexi√≥n por contacto espec√≠fico</label>
              <div id="cspRepeater" class="repeat-list"></div>
            </div>
          </div>

          <div class="section">
            <h3>Par√°metros del sistema</h3>
            <div class="field-row">
              <div class="field">
                <label>Longitud alimentador (m)</label>
                <input name="largo_alim_m" type="number" value="18" min="0" step=".1" inputmode="decimal" />
              </div>
              <div class="field">
                <label>Modo</label>
                <select name="forcedMode" id="forcedMode">
                  <option value="auto">Auto</option>
                  <option value="mono">Monof√°sico</option>
                  <option value="bifa">Bif√°sico</option>
                  <option value="trifa">Trif√°sico</option>
                </select>
              </div>
            </div>
            <div class="muted">Longitudes individuales se ajustan en ‚ÄúPropuesta‚Äù.</div>
          </div>

          <div id="entryError" class="error-box"></div>

          <div class="actions">
            <div class="row">
              <button type="button" id="btnCalc">Calcular</button>
              <button type="button" id="btnDemo" class="secondary">Demo r√°pida</button>
            </div>
            <div class="row">
              <button type="button" id="btnCopy" class="secondary">Copiar resumen</button>
            </div>
          </div>
        </form>
      </div>

      <!-- RESULTADOS -->
      <div class="card">
        <div class="tabs" id="tabs">
          <div class="tab active" data-tab="proposal">Propuesta</div>
          <div class="tab" data-tab="balance">Balance</div>
          <div class="tab" data-tab="resumen">Resumen</div>
          <div class="tab" data-tab="estructurado">Estructurado</div>
          <div class="tab" data-tab="unifilar">Unifilar</div>
          <div class="pill" id="statusRight">‚Äî</div>
        </div>

        <div class="tab-panel active" id="panel-proposal">
          <div class="panel-header">
            <h3 style="margin:0;">Propuesta de circuitos</h3>
            <span id="statusProp" class="pill">‚Äî</span>
          </div>
          <div id="proposal">Realiza un c√°lculo para ver la propuesta‚Ä¶</div>
        </div>

        <div class="tab-panel" id="panel-balance">
          <div class="panel-header">
            <h3 style="margin:0;">Balance de cargas</h3>
            <span id="statusBalance" class="pill">‚Äî</span>
          </div>
          <div id="balanceSummary" class="muted">Se mostrar√° cuando el sistema sea bif√°sico o trif√°sico.</div>
          <div id="balanceTableWrap" style="margin-top:.6rem; overflow:auto; display:none;">
            <table id="balanceTable">
              <thead>
                <tr><th>#</th><th>Circuito</th><th>Tipo</th><th>VA</th><th>Fase</th></tr>
              </thead>
              <tbody id="balanceTBody"></tbody>
            </table>
            <div class="actions" style="margin-top:.75rem;">
              <div class="row">
                <button type="button" id="btnApplyBalance" class="secondary small" disabled>Aplicar manual</button>
                <button type="button" id="btnAutoBalance" class="secondary small" disabled>Auto balance</button>
              </div>
            </div>
            <div id="balanceNotice" class="muted" style="margin-top:.4rem;"></div>
          </div>
        </div>

        <div class="tab-panel" id="panel-resumen">
          <div class="panel-header">
            <h3 style="margin:0;">Resumen</h3>
            <span id="statusCalc" class="pill">‚Äî</span>
          </div>
          <pre id="resumen">‚Äî</pre>
        </div>

        <div class="tab-panel" id="panel-estructurado">
          <div class="panel-header">
            <h3 style="margin:0;">Resumen estructurado</h3>
            <span id="statusStruct" class="pill">‚Äî</span>
          </div>
          <div id="structured" class="muted">Se mostrar√° tras recalcular.</div>
        </div>

        <div class="tab-panel" id="panel-unifilar">
          <div class="panel-header">
            <h3 style="margin:0;">Diagrama unifilar (SVG)</h3>
            <span id="statusSLD" class="pill">‚Äî</span>
          </div>
          <div class="toolbar">
            <button type="button" id="btnGenSLD" class="secondary small">Regenerar</button>
            <button type="button" id="btnFitWidth" class="secondary small">Ajustar al ancho</button>
            <button type="button" id="btnDownloadSLD" class="secondary small" disabled>SVG</button>
            <button type="button" id="btnDownloadSLDPNG" class="secondary small" disabled>PNG</button>
          </div>
          <div id="sldContainer" class="sld-wrap">‚Äî</div>
          <div class="muted" style="margin-top:.6rem;">VD>3% se marca en rojo; desbalance >5% en √°mbar.</div>
        </div>
      </div>
    </div>
  </div>

  <script src="./sld.js"></script>

  <script>
    /* ===== Tabs ===== */
    const tabsEl = document.getElementById('tabs');
    const panels = {
      proposal: document.getElementById('panel-proposal'),
      balance: document.getElementById('panel-balance'),
      resumen: document.getElementById('panel-resumen'),
      estructurado: document.getElementById('panel-estructurado'),
      unifilar: document.getElementById('panel-unifilar')
    };
    function setActiveTab(id) {
      const t = tabsEl.querySelector('.tab[data-tab="' + id + '"]');
      if (!t) return;
      tabsEl.querySelectorAll('.tab').forEach(el => el.classList.toggle('active', el === t));
      Object.entries(panels).forEach(([k, p]) => p.classList.toggle('active', k === id));
      if (id === 'unifilar') maybeGenerateSLD();
    }
    tabsEl.addEventListener('click', e => {
      const t = e.target.closest('.tab');
      if (t) setActiveTab(t.dataset.tab);
    });

    /* ===== Elementos ===== */
    const form = document.getElementById('calcForm');
    const btnCalc = document.getElementById('btnCalc');
    const btnDemo = document.getElementById('btnDemo');
    const btnCopy = document.getElementById('btnCopy');
    const btnApplyBalance = document.getElementById('btnApplyBalance');
    const btnAutoBalance = document.getElementById('btnAutoBalance');

    const btnRecalc = document.createElement('button');
    btnRecalc.type = 'button';
    btnRecalc.id = 'btnRecalc';
    btnRecalc.className = 'secondary';
    btnRecalc.textContent = 'Recalcular con longitudes';

    const statusRight = document.getElementById('statusRight');
    const statusProp = document.getElementById('statusProp');
    const statusBalance = document.getElementById('statusBalance');
    const statusCalc = document.getElementById('statusCalc');
    const statusStruct = document.getElementById('statusStruct');
    const statusSLD = document.getElementById('statusSLD');

    const proposalDiv = document.getElementById('proposal');
    const balanceSummary = document.getElementById('balanceSummary');
    const balanceTableWrap = document.getElementById('balanceTableWrap');
    const balanceTBody = document.getElementById('balanceTBody');
    const balanceNotice = document.getElementById('balanceNotice');
    const resumenEl = document.getElementById('resumen');
    const structuredDiv = document.getElementById('structured');
    const sldContainer = document.getElementById('sldContainer');
    const btnGenSLD = document.getElementById('btnGenSLD');
    const btnFitWidth = document.getElementById('btnFitWidth');
    const btnDownloadSLD = document.getElementById('btnDownloadSLD');
    const btnDownloadSLDPNG = document.getElementById('btnDownloadSLDPNG');

    const entryError = document.getElementById('entryError');

    const DEFAULT_L_DERIV = 10;

    const parseNumList = s => (!s || !s.trim()) ? [] :
      s.split(',').map(x => Number(String(x).trim().replace(',', '.'))).filter(Number.isFinite);
    const safeInt = v => { const n = Number(v); return Number.isFinite(n) ? n : 0; };
    const clampArrayLen = (arr, len, fillVal) => {
      arr = Array.isArray(arr) ? arr.slice(0, len) : [];
      while (arr.length < len) arr.push(fillVal);
      return arr;
    };
    const tipoOptionsBySystem = sistema => {
      if (sistema === 'Trif√°sico') return ['mono', 'bifa', 'trifa'];
      if (sistema === 'Bif√°sico') return ['mono', 'bifa'];
      return ['mono'];
    };

    const inpBombas = document.getElementById('inpBombas');
    const inpBombasHP = document.getElementById('inpBombasHP');
    const bombasRepeater = document.getElementById('bombasRepeater');
    const inpCspCant = document.getElementById('inpCspCant');
    const inpCspW = document.getElementById('inpCspW');
    const cspRepeater = document.getElementById('cspRepeater');
    const forcedModeSel = document.getElementById('forcedMode');

    function currentSystem() {
      const fm = forcedModeSel.value || 'auto';
      if (fm === 'mono') return 'Monof√°sico';
      if (fm === 'bifa') return 'Bif√°sico';
      if (fm === 'trifa') return 'Trif√°sico';
      return 'Trif√°sico';
    }

    function renderBombasRepeater() {
      const sistema = currentSystem();
      const tiposPerm = tipoOptionsBySystem(sistema);
      const n = Math.max(0, safeInt(inpBombas.value));
      const hpList = clampArrayLen(parseNumList(inpBombasHP.value), n, 1);
      const existingValues = Array.from(bombasRepeater.querySelectorAll('select[name^="BombaTipo_"]')).map(sel => sel.value);

      bombasRepeater.innerHTML = '';
      for (let i = 0; i < n; i++) {
        const hpVal = hpList[i] ?? 1;
        const prev = existingValues[i] || 'mono';
        const optsHTML = tiposPerm.map(t =>
          '<option value="' + t + '"' + (t === prev ? ' selected' : '') + '>' + t.toUpperCase() + '</option>'
        ).join('');
        bombasRepeater.insertAdjacentHTML('beforeend',
          '<div class="repeat-item">' +
            '<label>Bomba ' + (i + 1) + ' ‚Ä¢ HP: ' + hpVal + '</label>' +
            '<select name="BombaTipo_' + i + '">' + optsHTML + '</select>' +
          '</div>');
      }
    }

    function renderCspRepeater() {
      const sistema = currentSystem();
      const tiposPerm = tipoOptionsBySystem(sistema);
      const n = Math.max(0, safeInt(inpCspCant.value));
      const wList = clampArrayLen(parseNumList(inpCspW.value), n, 0);
      const existingValues = Array.from(cspRepeater.querySelectorAll('select[name^="CspTipo_"]')).map(sel => sel.value);

      cspRepeater.innerHTML = '';
      for (let i = 0; i < n; i++) {
        const wVal = wList[i] ?? 0;
        const prev = existingValues[i] || 'mono';
        const optsHTML = tiposPerm.map(t =>
          '<option value="' + t + '"' + (t === prev ? ' selected' : '') + '>' + t.toUpperCase() + '</option>'
        ).join('');
        cspRepeater.insertAdjacentHTML('beforeend',
          '<div class="repeat-item">' +
            '<label>CE ' + (i + 1) + ' ‚Ä¢ ' + wVal + ' W</label>' +
            '<select name="CspTipo_' + i + '">' + optsHTML + '</select>' +
          '</div>');
      }
    }

    function enforceSelectorsBySystem() {
      const sistema = currentSystem();
      const tiposPerm = tipoOptionsBySystem(sistema);

      bombasRepeater.querySelectorAll('select[name^="BombaTipo_"]').forEach(sel => {
        Array.from(sel.options).forEach(opt => opt.disabled = !tiposPerm.includes(opt.value));
        if (!tiposPerm.includes(sel.value)) sel.value = tiposPerm[0];
      });
      cspRepeater.querySelectorAll('select[name^="CspTipo_"]').forEach(sel => {
        Array.from(sel.options).forEach(opt => opt.disabled = !tiposPerm.includes(opt.value));
        if (!tiposPerm.includes(sel.value)) sel.value = tiposPerm[0];
      });
    }

    inpBombas.addEventListener('input', () => { renderBombasRepeater(); enforceSelectorsBySystem(); });
    inpBombasHP.addEventListener('input', () => { renderBombasRepeater(); enforceSelectorsBySystem(); });
    inpCspCant.addEventListener('input', () => { renderCspRepeater(); enforceSelectorsBySystem(); });
    inpCspW.addEventListener('input', () => { renderCspRepeater(); enforceSelectorsBySystem(); });
    forcedModeSel.addEventListener('change', () => { renderBombasRepeater(); renderCspRepeater(); enforceSelectorsBySystem(); });

    renderBombasRepeater();
    renderCspRepeater();
    enforceSelectorsBySystem();

    function gatherBasePayload() {
      const fd = new FormData(form);

      const cspCant = Number(fd.get('ContactosEspecificos_Cant') || 0);
      let cspWList = parseNumList(fd.get('ContactosEspecificos_W_List'));
      cspWList = clampArrayLen(cspWList, cspCant, 0);
      const cspTipos = Array.from(cspRepeater.querySelectorAll('select[name^="CspTipo_"]'))
        .map(sel => sel.value || 'mono');
      const cspTiposClamped = clampArrayLen(cspTipos, cspCant, 'mono');

      const bombas = Number(fd.get('Bombas') || 0);
      let bombasHP = parseNumList(fd.get('Bombas_HP_List'));
      bombasHP = clampArrayLen(bombasHP, bombas, 1);
      const bombasTipos = Array.from(bombasRepeater.querySelectorAll('select[name^="BombaTipo_"]'))
        .map(sel => sel.value || 'mono');
      const bombasTiposClamped = clampArrayLen(bombasTipos, bombas, 'mono');

      return {
        Focos: Number(fd.get('Focos') || 0),
        PotFoco_W: Number(fd.get('PotFoco_W') || 9),
        Contactos: Number(fd.get('Contactos') || 0),

        Bombas: bombas,
        Bombas_HP_List: bombasHP,
        Bombas_Tipos_List: bombasTiposClamped,

        ContactosEspeciales: Number(fd.get('ContactosEspeciales') || 0),

        ContactosEspecificos_Cant: cspCant,
        ContactosEspecificos_W_List: cspWList,
        ContactosEspecificos_Tipos_List: cspTiposClamped,

        largo_alim_m: Number(fd.get('largo_alim_m') || 0),
        forcedMode: fd.get('forcedMode') || 'auto'
      };
    }

    function validateTypesAgainstSystem() {
      entryError.classList.remove('show');
      entryError.textContent = '';
      const sistema = currentSystem();
      const tiposPerm = tipoOptionsBySystem(sistema);
      const invalids = [];

      bombasRepeater.querySelectorAll('select[name^="BombaTipo_"]').forEach((sel, i) => {
        if (!tiposPerm.includes(sel.value)) {
          invalids.push('Bomba ' + (i + 1) + ': tipo ' + sel.value.toUpperCase() +
                       ' inv√°lido para sistema ' + sistema + '.');
        }
      });
      cspRepeater.querySelectorAll('select[name^="CspTipo_"]').forEach((sel, i) => {
        if (!tiposPerm.includes(sel.value)) {
          invalids.push('CE ' + (i + 1) + ': tipo ' + sel.value.toUpperCase() +
                       ' inv√°lido para sistema ' + sistema + '.');
        }
      });

      if (invalids.length) {
        let msg = '';
        if (sistema === 'Monof√°sico') {
          msg = 'Sistema MONOF√ÅSICO: no puede conectar cargas BIF√ÅSICAS ni TRIF√ÅSICAS.';
        } else if (sistema === 'Bif√°sico') {
          msg = 'Sistema BIF√ÅSICO: no puede conectar cargas TRIF√ÅSICAS.';
        }
        entryError.innerHTML = '<strong>' + msg + '</strong><br>' + invalids.join('<br>');
        entryError.classList.add('show');
        return false;
      }
      return true;
    }

    function validateResultAndBlockUI(data, payload) {
      const sys = data && data.sistema && data.sistema.sistema || '';
      const sistema = String(sys);
      const tiposPerm = tipoOptionsBySystem(sistema);

      const bombasTipos = Array.isArray(payload && payload.Bombas_Tipos_List)
        ? payload.Bombas_Tipos_List : [];
      const cspTipos = Array.isArray(payload && payload.ContactosEspecificos_Tipos_List)
        ? payload.ContactosEspecificos_Tipos_List : [];

      const invalids = [];
      bombasTipos.forEach((t, i) => {
        if (!tiposPerm.includes(t)) {
          invalids.push('Bomba ' + (i + 1) + ': tipo ' + t.toUpperCase() +
                       ' inv√°lido para sistema ' + sistema + '.');
        }
      });
      cspTipos.forEach((t, i) => {
        if (!tiposPerm.includes(t)) {
          invalids.push('CE ' + (i + 1) + ': tipo ' + t.toUpperCase() +
                       ' inv√°lido para sistema ' + sistema + '.');
        }
      });

      const derived = (data && data.sistema && data.sistema.derived_proposal) ||
                      data.derived_proposal || [];
      derived.forEach(ci => {
        if (ci && ci.valido === false) {
          invalids.push(
            'Circuito ' + ci.idx + ' (' + ci.tipo + ') ‚Ä¢ ' +
            String(ci.tipo_conexion || '').toUpperCase() +
            ' inv√°lido para sistema ' + sistema + '.'
          );
        }
      });

      if (invalids.length) {
        let msg;
        if (sistema.indexOf('Mono') >= 0) {
          msg = 'Sistema MONOF√ÅSICO: no puede conectar cargas BIF√ÅSICAS ni TRIF√ÅSICAS.';
        } else if (sistema.indexOf('Bif') >= 0) {
          msg = 'Sistema BIF√ÅSICO: no puede conectar cargas TRIF√ÅSICAS.';
        } else {
          msg = 'Tipos de conexi√≥n inv√°lidos para el sistema.';
        }
        entryError.innerHTML = '<strong>' + msg + '</strong><br>' + invalids.join('<br>');
        entryError.classList.add('show');

        statusRight.textContent = 'Error'; statusRight.className = 'pill error';
        statusProp.textContent = '‚Äî'; statusBalance.textContent = '‚Äî';
        statusCalc.textContent = 'Error'; statusCalc.className = 'pill error';
        statusStruct.textContent = '‚Äî'; statusSLD.textContent = '‚Äî';
        proposalDiv.textContent = '‚Äî';
        balanceSummary.textContent = '‚Äî';
        balanceTableWrap.style.display = 'none';
        resumenEl.textContent = '‚Äî';
        structuredDiv.textContent = '‚Äî';
        sldContainer.textContent = '‚Äî';
        btnDownloadSLD.disabled = true;
        btnDownloadSLDPNG.disabled = true;
        return true;
      }
      return false;
    }

    function collectPerCircuitLengths() {
      const inputs = document.querySelectorAll('#proposal input[name^="L_"]');
      const L = { focos: [], contactos: [], especiales: [], bombas: [], contactosEspecificos: [] };
      inputs.forEach(inp => {
        const m = inp.name.match(/^L_(focos|contactos|especiales|bombas|contactosEspecificos)_(\d+)$/);
        if (!m) return;
        const key = m[1];
        const idx = Number(m[2]);
        L[key][idx] = Number(inp.value || 0);
      });
      Object.keys(L).forEach(k => { L[k] = (L[k] || []).map(v => Number(v || 0)); });
      return L;
    }

    function collectPhaseAssignments() {
      const sys = window.__lastData && window.__lastData.sistema || {};
      const assign = (sys.phase_balance && Array.isArray(sys.phase_balance.assignment))
        ? sys.phase_balance.assignment : [];
      return assign.map(row => {
        const sel = document.querySelector('select[name="phase_' + row.id + '"]');
        const fase = Number(sel ? sel.value : row.fase);
        return { id: row.id, fase };
      });
    }

    function calcDesb(totals) {
      const pos = (totals || []).filter(v => v > 0);
      if (!pos.length) return 0;
      const max = Math.max(...pos), min = Math.min(...pos);
      return max > 0 ? ((max - min) / max) * 100 : 0;
    }

    function previewTotals(assignments, sys) {
      const mapVA = {};
      (sys.phase_balance && sys.phase_balance.assignment || []).forEach(a => {
        mapVA[a.id] = a.VA;
      });
      if (Object.keys(mapVA).length === 0 && Array.isArray(sys.derived_proposal)) {
        sys.derived_proposal.forEach(ci => {
          mapVA[ci.key + '_' + ci.circuito_index] = ci.VA;
        });
      }
      const phaseCount = sys.phaseCount || (sys.sistema === 'Trif√°sico' ? 3 :
                           (sys.sistema === 'Bif√°sico' ? 2 : 1));
      const totals = Array.from({ length: phaseCount }, () => 0);
      assignments.forEach(a => {
        const f = (a.fase >= 1 && a.fase <= phaseCount) ? a.fase : 1;
        totals[f - 1] += Number(mapVA[a.id] || 0);
      });
      return totals;
    }

    async function run(payload, opts) {
      opts = opts || { showSummary: false };
      entryError.classList.remove('show');
      entryError.textContent = '';

      statusRight.textContent = 'Procesando‚Ä¶'; statusRight.className = 'pill';
      statusProp.textContent = '‚Äî'; statusBalance.textContent = '‚Äî';
      statusCalc.textContent = opts.showSummary ? 'Calculando‚Ä¶' : 'Pendiente'; statusCalc.className = 'pill';
      resumenEl.textContent = opts.showSummary
        ? 'Calculando‚Ä¶'
        : 'Modifica longitudes y pulsa ‚ÄúRecalcular con longitudes‚Äù.';
      structuredDiv.textContent = opts.showSummary ? 'Calculando‚Ä¶' : 'Se mostrar√° tras recalcular.';
      structuredDiv.classList.add('muted');
      statusStruct.textContent = '‚Äî'; statusStruct.className = 'pill';
      balanceSummary.textContent = 'Se mostrar√° cuando el sistema sea bif√°sico o trif√°sico.';
      balanceSummary.classList.add('muted');
      balanceTableWrap.style.display = 'none'; btnApplyBalance.disabled = true; btnAutoBalance.disabled = true; balanceNotice.textContent = '';
      statusSLD.textContent = '‚Äî'; sldContainer.innerHTML = '‚Äî'; btnDownloadSLD.disabled = true; btnDownloadSLDPNG.disabled = true;

      try {
        const res = await fetch('/api/v1/calculate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        window.__lastData = data;
        if (!data.ok) throw new Error(data.error || 'Error desconocido');

        const blocked = validateResultAndBlockUI(data, payload);
        if (blocked) {
          setActiveTab('proposal');
          return null;
        }

        statusRight.textContent = 'OK'; statusRight.className = 'pill ok';
        renderProposal(data.sistema || {});
        renderBalance(data);

        if (opts.showSummary) {
          statusCalc.textContent = 'OK'; statusCalc.className = 'pill ok';
          resumenEl.textContent = data.resumen || 'OK';
          renderStructured(data);
          statusStruct.textContent = 'OK'; statusStruct.className = 'pill ok';
        } else {
          statusCalc.textContent = 'Pendiente'; statusCalc.className = 'pill';
        }
        if (panels.unifilar.classList.contains('active')) maybeGenerateSLD();
        return data;
      } catch (err) {
        statusRight.textContent = 'Error'; statusRight.className = 'pill error';
        statusCalc.textContent = 'Error'; statusCalc.className = 'pill error';
        proposalDiv.innerHTML = '‚Äî'; resumenEl.textContent = 'Error: ' + err.message;
        structuredDiv.textContent = 'No disponible.';
        statusSLD.textContent = 'Error'; statusSLD.className = 'pill error';
        return null;
      }
    }

    function renderProposal(s) {
      if (!s || !Array.isArray(s.derived_proposal) || !s.derived_proposal.length) {
        statusProp.textContent = '‚Äî';
        proposalDiv.innerHTML = 'No hay circuitos derivados.';
        return;
      }
      statusProp.textContent = 'OK'; statusProp.className = 'pill ok';

      const rows = s.derived_proposal.map(ci => {
        const name = 'L_' + ci.key + '_' + ci.circuito_index;
        const current = Number(ci.L_m != null ? ci.L_m : DEFAULT_L_DERIV);
        const vdText = ci.vd_pct == null ? '‚Äî' : Number(ci.vd_pct).toFixed(2) + ' %';
        const itemsTxt =
          (ci.tipo === 'Contacto especial' || ci.tipo === 'Bomba' || ci.tipo === 'Contacto espec√≠fico')
            ? '' : ' (' + ci.items + ')';
        const tipoConn = ci.tipo_conexion ? ' ‚Ä¢ ' + String(ci.tipo_conexion).toUpperCase() : '';
        return (
          '<tr>' +
            '<td>' + ci.idx + '</td>' +
            '<td>' + ci.tipo + itemsTxt + tipoConn + (ci.valido === false ? ' ‚Ä¢ INV√ÅLIDO' : '') + '</td>' +
            '<td>' + Math.round(ci.VA) + ' VA</td>' +
            '<td>' + Number(ci.I).toFixed(2) + ' A</td>' +
            '<td>' + (ci.breaker || '‚Äî') + ' A / ' + (ci.cal || '‚Äî') + '</td>' +
            '<td><input type="number" min="0" step=".1" value="' + current +
              '" style="width:90px" name="' + name + '" inputmode="decimal"></td>' +
            '<td>' + vdText + '</td>' +
          '</tr>'
        );
      }).join('');

      proposalDiv.innerHTML =
        '<div style="overflow:auto;">' +
          '<table>' +
            '<thead>' +
              '<tr>' +
                '<th>#</th><th>Circuito</th><th>VA</th><th>I</th>' +
                '<th>Protecci√≥n/Calibre</th><th>Longitud (m)</th><th>VD actual</th>' +
              '</tr>' +
            '</thead>' +
            '<tbody>' + rows + '</tbody>' +
          '</table>' +
        '</div>' +
        '<div class="muted" style="margin-top:.4rem;">Ajusta longitudes y pulsa ‚ÄúRecalcular con longitudes‚Äù.</div>' +
        '<div id="proposal-actions" style="margin-top:.8rem; display:flex; justify-content:flex-end;"></div>';

      const container = document.getElementById('proposal-actions');
      container.innerHTML = '';
      container.appendChild(btnRecalc);
    }

    function renderBalance(data) {
      const s = data.sistema || {};
      statusBalance.textContent = '‚Äî'; statusBalance.className = 'pill';
      balanceSummary.textContent = 'Balance no aplica.'; balanceSummary.classList.add('muted');
      balanceTableWrap.style.display = 'none'; btnApplyBalance.disabled = true; btnAutoBalance.disabled = true; balanceNotice.textContent = '';

      if (!s.balanceEnabled || !s.phase_balance || (s.phaseCount || 1) <= 1) return;

      const totals = s.phase_balance.totals || [];
      const fasesTxt = totals.map((v, i) => 'F' + (i + 1) + ': ' + Math.round(v) + ' VA').join(' ‚Ä¢ ');
      const desb = s.phase_balance.desbalance_pct != null
        ? Number(s.phase_balance.desbalance_pct).toFixed(2) : '‚Äî';

      statusBalance.textContent = 'OK'; statusBalance.className = 'pill ok';
      balanceSummary.textContent = '‚Ä¢ ' + fasesTxt + ' ‚Ä¢ Desbalance: ' + desb + '% (lim ‚â§ 5.00%)';
      balanceSummary.classList.remove('muted');

      const sorted = (s.phase_balance.assignment || []).slice().sort(
        (a, b) => (a.fase - b.fase) || ((a.idx || 0) - (b.idx || 0))
      );
      balanceTBody.innerHTML = sorted.map(row => {
        const opts = Array.from({ length: s.phaseCount || 2 }, (_, i) =>
          '<option value="' + (i + 1) + '"' + (row.fase === (i + 1) ? ' selected' : '') +
          '>F' + (i + 1) + '</option>'
        ).join('');
        const tipoConn = row.tipo_conexion ? ' ‚Ä¢ ' + String(row.tipo_conexion).toUpperCase() : '';
        return (
          '<tr>' +
            '<td>' + (row.idx || '‚Äî') + '</td>' +
            '<td>' + row.key.toUpperCase() + (row.circuito_index + 1) + '</td>' +
            '<td>' + row.tipo + tipoConn + '</td>' +
            '<td>' + Math.round(row.VA) + ' VA</td>' +
            '<td><select name="phase_' + row.id + '">' + opts + '</select></td>' +
          '</tr>'
        );
      }).join('');

      balanceTableWrap.style.display = 'block';
      btnApplyBalance.disabled = false;
      btnAutoBalance.disabled = false;

      balanceTBody.querySelectorAll('select[name^="phase_"]').forEach(sel => {
        sel.addEventListener('change', onPhaseSelectChanged);
      });
    }

    function onPhaseSelectChanged() {
      const sys = window.__lastData && window.__lastData.sistema;
      if (!sys || !sys.phase_balance) return;

      const selected = collectPhaseAssignments();
      const totals = previewTotals(selected, sys);
      const desb = calcDesb(totals);

      balanceSummary.textContent =
        '‚Ä¢ ' +
        totals.map((v, i) => 'F' + (i + 1) + ': ' + Math.round(v) + ' VA').join(' ‚Ä¢ ') +
        ' ‚Ä¢ Desbalance: ' + desb.toFixed(2) + '% (lim ‚â§ 5.00%)';
      balanceSummary.classList.remove('muted');

      const meta = {};
      sys.phase_balance.assignment.forEach(a => { meta[a.id] = a; });
      const previewAssign = selected.map(sel => {
        const base = meta[sel.id] || {};
        return Object.assign({}, base, { fase: sel.fase });
      });
      const phaseCount = sys.phaseCount || 2;
      balanceTBody.innerHTML = previewAssign.map(row => {
        const opts = Array.from({ length: phaseCount }, (_, i) =>
          '<option value="' + (i + 1) + '"' + (row.fase === (i + 1) ? ' selected' : '') +
          '>F' + (i + 1) + '</option>'
        ).join('');
        const tipoConn = row.tipo_conexion ? ' ‚Ä¢ ' + String(row.tipo_conexion).toUpperCase() : '';
        return (
          '<tr>' +
            '<td>' + (row.idx || '‚Äî') + '</td>' +
            '<td>' + row.key.toUpperCase() + (row.circuito_index + 1) + '</td>' +
            '<td>' + row.tipo + tipoConn + '</td>' +
            '<td>' + Math.round(row.VA) + ' VA</td>' +
            '<td><select name="phase_' + row.id + '">' + opts + '</select></td>' +
          '</tr>'
        );
      }).join('');

      balanceTBody.querySelectorAll('select[name^="phase_"]').forEach(sel => {
        sel.addEventListener('change', onPhaseSelectChanged);
      });

      balanceNotice.textContent = 'PREVIEW ‚Ä¢ Desbalance: ' + desb.toFixed(2) + '%';
      balanceNotice.classList.remove('muted');
      balanceNotice.classList.toggle('warn', desb > 5);
    }

    /* ==== Resumen estructurado (restaurado) ==== */
    function renderStructured(data) {
      const s = data.sistema || {};
      const div = structuredDiv;

      const fmt = {
        A: v => `${Number(v || 0).toFixed(2)} A`,
        VA: v => `${Math.round(v || 0)} VA`,
        pct: v => v == null ? '‚Äî' : `${Number(v).toFixed(2)} %`
      };

      const blocks = [];

      // General
      blocks.push(section(
        'General',
        `Folio: <strong>${data.folio}</strong><br>` +
        `Sistema: ${s.sistema} (recomendado: ${s.recomendado})<br>` +
        `Demanda: ${fmt.VA(s.VA_demanda_total)} ‚Äì Instalada: ${fmt.VA(s.VA_instalada_total)}<br>` +
        `kW: ${Number(s.kW || 0).toFixed(3)}`
      ));

      // Alimentador
      blocks.push(section(
        'Alimentador',
        `I=${fmt.A(s.I_alim)}<br>` +
        `Conductor: ${s.cal_alim} | Interruptor: ${s.proteccion} A<br>` +
        `VD: ${fmt.pct(s.vd_alim)} ‚Ä¢ Longitud: ${s.largo_alim_m} m`
      ));

      // Luminarias
      if (s.nFocos > 0) {
        const VA_circ = (s.VA_focos || 0) / s.nFocos;
        blocks.push(section(
          'Luminarias',
          `Circuitos: ${s.nFocos} ‚Ä¢ VA/circuito: ${fmt.VA(VA_circ)}<br>` +
          `Breaker: ${s.int_focos} A ‚Ä¢ Conductor: ${s.cal_focos || '‚Äî'}`
        ));
      }

      // Contactos
      if (s.nContactos > 0) {
        const VA_circ = (s.VA_contactos || 0) / s.nContactos;
        blocks.push(section(
          'Contactos',
          `Circuitos: ${s.nContactos} ‚Ä¢ VA/circuito: ${fmt.VA(VA_circ)}<br>` +
          `Breaker: ${s.int_contactos} A ‚Ä¢ Conductor: ${s.cal_cont || '‚Äî'}`
        ));
      }

      // Especiales
      if (s.nContactosEspeciales > 0) {
        blocks.push(section(
          'Especiales',
          `Cantidad: ${s.nContactosEspeciales} ‚Ä¢ I‚âà${fmt.A(s.I_circ_especial)}<br>` +
          `Breaker: ${s.int_contactos_especiales} A ‚Ä¢ Conductor: ${s.cal_especial || '‚Äî'}`
        ));
      }

      // Bombas
      if (s.nBombas > 0) {
        const list = (s.I_bomba_list || []).map((I, i) => {
          const tipo = s.bombas_tipos_list?.[i]?.toUpperCase() || 'MONO';
          const br = s.int_bomba_list?.[i];
          const cal = s.cal_bomba_list?.[i] || '‚Äî';
          return `Bomba ${i + 1}: ${fmt.A(I)} ‚Ä¢ ${tipo} ‚Ä¢ Breaker ${br}A ‚Ä¢ Conductor ${cal}`;
        }).join('<br>');
        blocks.push(section('Bombas', list));
      }

      // Contactos espec√≠ficos
      if (s.nContactosEspecificos > 0) {
        const list = (s.contactosEspecificos_detalle || []).map((d, i) => {
          const tipo = d.tipo_conexion?.toUpperCase() || 'MONO';
          return `Contacto espec√≠fico ${i + 1}: ${fmt.VA(d.VA)} ‚Äì ${fmt.A(d.I)} ‚Äì ` +
                 `${tipo} ‚Äì ${d.breaker}A ‚Äì ${d.cal}`;
        }).join('<br>');
        blocks.push(section('Contactos espec√≠ficos', list));
      }

      // Balance
      if (s.balanceEnabled && s.phase_balance && s.phaseCount > 1) {
        const fasesTxt = (s.phase_balance.totals || [])
          .map((v, i) => `F${i + 1}: ${fmt.VA(v)}`)
          .join(' ‚Ä¢ ');
        blocks.push(section(
          'Balance',
          `${fasesTxt}<br>` +
          `Desbalance: ${fmt.pct(s.phase_balance.desbalance_pct)} (‚â§5%)`
        ));
      }

      div.innerHTML = blocks.join('');
      div.classList.remove('muted');

      function section(titulo, contenidoHtml) {
        return `
          <div style="margin-bottom:1rem;">
            <div style="font-weight:700;margin:.2rem 0 .4rem;color:#d5def0;font-size:1rem;">
              ${titulo}
            </div>
            <div style="font-size:.82rem;line-height:1.2rem;">
              ${contenidoHtml}
            </div>
          </div>
        `;
      }
    }

    function makeSVGResponsive(svg) {
      if (!svg) return;
      svg.removeAttribute('width');
      svg.removeAttribute('height');
      if (!svg.getAttribute('viewBox')) {
        const w = svg.width.baseVal.value || 1200;
        const h = svg.height.baseVal.value || 600;
        svg.setAttribute('viewBox', '0 0 ' + w + ' ' + h);
      }
      svg.setAttribute('preserveAspectRatio', 'xMinYMin meet');
      svg.style.width = '100%';
      svg.style.height = 'auto';
    }

    function maybeGenerateSLD() {
      const s = window.__lastData && window.__lastData.sistema;
      if (!s) {
        statusSLD.textContent = '‚Äî';
        sldContainer.textContent = 'Genera un c√°lculo para visualizar.';
        return;
      }
      try {
        const svgMarkup = window.generateSLD(s, {});
        sldContainer.innerHTML = svgMarkup;
        const svg = sldContainer.querySelector('svg');
        makeSVGResponsive(svg);
        statusSLD.textContent = 'OK'; statusSLD.className = 'pill ok';
        btnDownloadSLD.disabled = false;
        btnDownloadSLDPNG.disabled = false;
      } catch (e) {
        statusSLD.textContent = 'Error'; statusSLD.className = 'pill error';
        sldContainer.textContent = 'No fue posible generar el unifilar.';
      }
    }

    btnGenSLD.addEventListener('click', () => maybeGenerateSLD());
    btnFitWidth.addEventListener('click', () => {
      const svg = sldContainer.querySelector('svg');
      makeSVGResponsive(svg);
      sldContainer.scrollLeft = 0;
    });

    btnCalc.addEventListener('click', () => {
      if (!validateTypesAgainstSystem()) {
        setActiveTab('proposal');
        return;
      }
      setActiveTab('proposal');
      run(gatherBasePayload(), { showSummary: false });
    });

    btnDemo.addEventListener('click', () => {
      setActiveTab('proposal');
      inpBombas.value = 3; inpBombas.dispatchEvent(new Event('input'));
      inpBombasHP.value = '1, 1, 2'; inpBombasHP.dispatchEvent(new Event('input'));
      inpCspCant.value = 3; inpCspCant.dispatchEvent(new Event('input'));
      inpCspW.value = '800, 1200, 600'; inpCspW.dispatchEvent(new Event('input'));
      renderBombasRepeater(); renderCspRepeater(); enforceSelectorsBySystem();
      entryError.classList.remove('show');
      run(gatherBasePayload(), { showSummary: false });
    });

    btnRecalc.addEventListener('click', async () => {
      if (!validateTypesAgainstSystem()) {
        setActiveTab('proposal');
        return;
      }
      setActiveTab('proposal');
      const base = gatherBasePayload();
      const L = collectPerCircuitLengths();
      const payload = Object.assign({}, base, {
        L_focos: L.focos,
        L_contactos: L.contactos,
        L_especiales: L.especiales,
        L_bombas: L.bombas,
        L_contactosEspecificos: L.contactosEspecificos
      });
      await run(payload, { showSummary: true });
    });

    btnApplyBalance.addEventListener('click', async () => {
      if (!validateTypesAgainstSystem()) {
        setActiveTab('proposal');
        return;
      }
      const sys = window.__lastData && window.__lastData.sistema;
      if (!sys || !sys.phase_balance) return;
      const selected = collectPhaseAssignments();
      const base = gatherBasePayload();
      const L = collectPerCircuitLengths();
      const payload = Object.assign({}, base, {
        L_focos: L.focos,
        L_contactos: L.contactos,
        L_especiales: L.especiales,
        L_bombas: L.bombas,
        L_contactosEspecificos: L.contactosEspecificos,
        PhaseAssignments: selected
      });
      const data = await run(payload, { showSummary: true });
      if (!data || !data.sistema || !data.sistema.phase_balance) return;
      const desb = data.sistema.phase_balance.desbalance_pct;
      balanceNotice.textContent = 'Balance aplicado. Desbalance definitivo: ' + desb.toFixed(2) + '%';
      balanceNotice.classList.remove('muted');
      balanceNotice.classList.toggle('warn', desb > 5);
      setActiveTab('balance');
    });

    btnAutoBalance.addEventListener('click', async () => {
      if (!validateTypesAgainstSystem()) {
        setActiveTab('proposal');
        return;
      }
      const base = gatherBasePayload();
      const L = collectPerCircuitLengths();
      const payload = Object.assign({}, base, {
        L_focos: L.focos,
        L_contactos: L.contactos,
        L_especiales: L.especiales,
        L_bombas: L.bombas,
        L_contactosEspecificos: L.contactosEspecificos
      });
      const data = await run(payload, { showSummary: true });
      if (!data || !data.sistema || !data.sistema.phase_balance) return;
      const desb = data.sistema.phase_balance.desbalance_pct;
      balanceNotice.textContent = 'Balance autom√°tico aplicado. Desbalance: ' + desb.toFixed(2) + '%';
      balanceNotice.classList.remove('muted');
      balanceNotice.classList.toggle('warn', desb > 5);
      setActiveTab('balance');
    });

    btnCopy.addEventListener('click', () => {
      if (!resumenEl.textContent || resumenEl.textContent === '‚Äî') return;
      navigator.clipboard.writeText(resumenEl.textContent).then(() => {
        btnCopy.textContent = 'Copiado!';
        setTimeout(() => { btnCopy.textContent = 'Copiar resumen'; }, 1400);
      });
    });
  </script>

  <footer style="margin-top:2rem;padding:1rem 3rem 0 3rem;font-size:.9rem;line-height:1.7;color:#9fb3d3;border-top:1px solid #1c2a5c;text-align:left;">
    <p style="margin:0.2rem 0;">¬© 2025 Carlos Joel Toledo Mart√≠nez. LIMATRON ‚Äì Sistema experto para c√°lculo de instalaciones el√©ctricas.</p>
    <p style="margin:0.2rem 0;">Todos los derechos reservados. El uso no autorizado de este software queda estrictamente prohibido.</p>
    <p style="margin:0.2rem 0;">Los resultados son de apoyo al c√°lculo y no sustituyen la revisi√≥n y validaci√≥n de un profesional autorizado.</p>
  </footer>
</body>
</html>
